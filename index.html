<!DOCTYPE html>
<html>

<head>
    <link rel="stylesheet" href="assets/css/newstyle.css">
</head>

<body>
    <h1>Hanzi Converters</h1>
    <p>Input Simplified characters into these converters; the Multilingual Dictionary also supports Xinjianti. Note that outside of fixed compounds, Simplified characters have a "default" traditional form on which they fall back when they have multiple definitions, so it is recommended to proofread these characters after conversion if they are used in isolation. <a href="https://fareast-english.fandom.com/wiki/List_of_New_Simplified_Forms_of_Chinese_Characters">Here is a list of traditional characters which the converter recognizes.</a></p>
    <h2>Xinjianti Converter</h2>

    <form>
      <input type="text" id="fname" name="fname"><br><br>
      <input type="button" value="Convert" onclick="msg()">
      <input type="button" value="Compatibility Mode" onclick="compat()">
    </form>
    
    <h5 id="compmode"><i></i></h5>
    <p id="demo">Enter a value above and click the button to convert it</p>

    <h2>Multilingual Dictionary</h2>
    <!-- <p>Test font 何故鞦甚榮？</p> -->
    <p>Japanese kun'yomi is supported, but not Vietnamese huấn độc nor Korean hundok unless they are nativizations of Sino-Xenic terms.</p>

    <form>
      <input type="text" id="termin" name="termin"><br><br>
      <input type="button" id="defbutton" value="Lookup" onclick="define()">
      <input type="button" id="vbutton" value="Vietnamese" onclick="makeViet()">
      <input type="button" id="kbutton" value="Korean" onclick="makeKor()">
      <input type="button" id="jbutton" value="Japanese" onclick="makeJap()">
      <input type="button" id="cbutton" value="Chinese" onclick="makeChi()">
      <input type="button" id="tlbutton" value="Sino-Xenic" onclick="makeTl()">
    </form>
    
    <p id="termout">Enter a single term to be defined</p>
    <p id="termout2"></p>

    <script>
        var compats = false;
        var viet = false;
        var kor = false;
        var jap = false;
        var chi = false;
        var tl = false;
        const button = document.getElementById("defbutton");
        const vbutton = document.getElementById("vbutton");
        const kbutton = document.getElementById("kbutton");
        const jbutton = document.getElementById("jbutton");
        const cbutton = document.getElementById("cbutton");
        const tlbutton = document.getElementById("tlbutton");
        button.disabled = true;
        var csv = "";
        var dataArray;
        var request = new XMLHttpRequest();
        request.open('GET', 'https://EricL22.github.io/assets/data/xn-dict.csv', true);
        request.responseType = 'blob';
        request.onload = function() {
            var reader = new FileReader();
            reader.readAsText(request.response);
            reader.onload =  function(e){
                //console.log('Text:', e.target.result);
                csv = e.target.result;
        
                //var csv = '"foo, the column",bar\n2,3\n"4, the value",5',

                    // Split the input into lines
                    lines = csv.split('\n'),

                    // Extract column names from the first line
                    columnNamesLine = lines[0],
                    columnNames = parse(columnNamesLine),

                    // Extract data from subsequent lines
                    dataLines = lines.slice(1),
                    data = dataLines.map(parse);

                // Prints [["2","3"],["4, the value","5"]]
                dataArray = data;
                //console.log(JSON.stringify(dataArray));
            };
        };
        request.send();
        
        // Parse a CSV row, accounting for commas inside quotes                   
        function parse(row){
          var insideQuote = false,                                             
              entries = [],                                                    
              entry = [];
          row.split('').forEach(function (character) {                         
            if(character === '"') {
              insideQuote = !insideQuote;                                      
            } else {
              if(character == "," && !insideQuote) {                           
                entries.push(entry.join(''));                                  
                entry = [];                                                    
              } else {
                entry.push(character);                                         
              }                                                                
            }                                                                  
          });
          entries.push(entry.join(''));                                        
          return entries;                                                      
        }
        function compat() {
            var x = document.getElementById("compmode");
            if (x.textContent === "") {
                x.textContent = new String("Compatibility Mode Enabled");
                x.style.fontStyle = "italic";
            } else {
                x.textContent = "";
            }
            compats = !compats;
        }
        function msg() {
            const MAX_STRING_SIZE = 15;
            const paragraph = document.getElementById("demo");
            var checkString = document.getElementById("fname").value;
            var output = "";
            paragraph.textContent = "Working...";
            setTimeout(function() {
                while (checkString.length > 0)
                {
                    OUTER_LOOP: for (let i = checkString.length; i > 0; i--)
                    {
                        if (checkString.substring(0, i).length > MAX_STRING_SIZE)   continue;
                        for (let j = 0; j < dataArray.length; j++)
                        {
                            for (let k = 0; k < dataArray[j].length; k++)
                            {
                                if (checkString.substring(0, i) == dataArray[j][k] && isNaN(checkString.substring(0, i)))
                                {
                                    if (dataArray[j][3] == "1" || compats && dataArray[j][4] == "1")
                                        output += dataArray[j][2];
                                    else if (dataArray[j][3] == "" || dataArray[j][3].match(/^[0-9]+$/) != null || compats && dataArray[j][4] == "0")
                                        output += dataArray[j][1];
                                    else
                                        output += dataArray[j][3];
                                    checkString = checkString.substring(i);
                                    break OUTER_LOOP;
                                }
                                else if (j == dataArray.length - 1 && k == dataArray[j].length - 1 && i == 1)
                                {
                                    output += checkString.substring(0, i);
                                    checkString = checkString.substring(i);
                                    break OUTER_LOOP;
                                }
                            }
                        }
                    }
                }
                paragraph.textContent = output;
            }, 1);
        }
        function makeViet() {
            viet = true;
            kor = false;
            jap = false;
            chi = false;
            tl = false;
            vbutton.disabled = true;
            jbutton.disabled = false;
            kbutton.disabled = false;
            cbutton.disabled = false;
            tlbutton.disabled = false;
            button.disabled = false;
        }
        function makeKor() {
            kor = true;
            viet = false;
            jap = false;
            chi = false;
            tl = false;
            vbutton.disabled = false;
            jbutton.disabled = false;
            kbutton.disabled = true;
            cbutton.disabled = false;
            tlbutton.disabled = false;
            button.disabled = false;
        }
        function makeJap() {
            jap = true;
            viet = false;
            kor = false;
            chi = false;
            tl = false;
            vbutton.disabled = false;
            jbutton.disabled = true;
            kbutton.disabled = false;
            cbutton.disabled = false;
            tlbutton.disabled = false;
            button.disabled = false;
        }
        function makeChi() {
            chi = true;
            viet = false;
            kor = false;
            jap = false;
            tl = false;
            vbutton.disabled = false;
            jbutton.disabled = false;
            kbutton.disabled = false;
            cbutton.disabled = true;
            tlbutton.disabled = false;
            button.disabled = false;
        }
        function makeTl() {
            tl = true;
            viet = false;
            kor = false;
            jap = false;
            chi = false;
            vbutton.disabled = false;
            jbutton.disabled = false;
            kbutton.disabled = false;
            cbutton.disabled = false;
            tlbutton.disabled = true;
            button.disabled = false;
        }
        function define() {
            const paragraph = document.getElementById("termout");
            const paragraph2 = document.getElementById("termout2");
            var checkString = document.getElementById("termin").value;
            var output = "";
            var output2 = "";
            var foundMatch = false;
            OUTER_LOOP: for (let j = 0; j < dataArray.length; j++)
            {
                for (let k = 0; k < dataArray[j].length; k++)
                {
                    let foundAltReading = false;
                    if ((k == 5 || k == 6 || k == 7 || k == 8) && (dataArray[j][k].indexOf("|") > -1 || dataArray[j][k].indexOf("::") > -1))
                    {
                        let alts = [];
                        let altReading = dataArray[j][k].replaceAll(" ", "");
                        while (altReading.indexOf("|") > -1)
                        {
                            let nthterm = altReading.substring(0, altReading.indexOf("|"));
                            alts.push(nthterm);
                            altReading = altReading.substring(altReading.indexOf("|") + 1);
                        }
                        alts.push(altReading);
                        for (let i = 0; i < alts.length; i++)
                        {
                            while (alts[i].indexOf("::") > -1)
                            {
                                let nthterm = alts[i].substring(0, alts[i].indexOf("::"));
                                alts.push(nthterm);
                                alts[i] = alts[i].substring(alts[i].indexOf("::") + 2);
                            }
                            if (checkString == alts[i])
                                foundAltReading = true;
                        }
                    }
                    if ((checkString == dataArray[j][k] || foundAltReading) && isNaN(checkString))
                    {
                        foundMatch = true;
                        let xinterm = "";
                        if (dataArray[j][3] == "1")
                            xinterm += dataArray[j][2];
                        else if (dataArray[j][3] == "" || dataArray[j][3].match(/^[0-9]+$/) != null)
                            xinterm += dataArray[j][1];
                        else
                            xinterm += dataArray[j][3];
                        let rdgs = [];
                        let defs = [];
                        let okus = [];
                        if (tl)
                        {
                            output += "（" + xinterm + "）<br>";
                            output += "Chinese: ";
                            if (dataArray[j][8] == "") output += "No reading found<br>";
                            else output += dataArray[j][8].replaceAll("::", ", ") + "<br>";
                            output += "Japanese: ";
                            if (dataArray[j][7] == "") output += "No reading found<br>";
                            else
                            {
                                rdgs = [];
                                okus = [];
                                let okuCopy = dataArray[j][14];
                                while (okuCopy.indexOf("::") > -1)
                                {
                                    let nthterm = okuCopy.substring(0, okuCopy.indexOf("::"));
                                    okus.push(nthterm);
                                    okuCopy = okuCopy.substring(okuCopy.indexOf("::") + 2);
                                }
                                okus.push(okuCopy);
                                let termCopy = dataArray[j][7];
                                while (termCopy.indexOf("::") > -1)
                                {
                                    let nthterm = termCopy.substring(0, termCopy.indexOf("::"));
                                    rdgs.push(nthterm);
                                    termCopy = termCopy.substring(termCopy.indexOf("::") + 2);
                                }
                                rdgs.push(termCopy);
                                for (let i = 0; i < rdgs.length; i++)
                                    if (i >= okus.length || okus[i] == "")
                                        output += rdgs[i] + ", ";
                                if (output.charAt(output.length - 2) == ",") output = output.substring(0, output.length-2);
                                output += "<br>";
                            }
                            output += "Korean: ";
                            if (dataArray[j][6] == "") output += "No reading found<br>";
                            else
                            {
                                rdgs = [];
                                okus = [];
                                let okuCopy = dataArray[j][15];
                                while (okuCopy.indexOf("::") > -1)
                                {
                                    let nthterm = okuCopy.substring(0, okuCopy.indexOf("::"));
                                    okus.push(nthterm);
                                    okuCopy = okuCopy.substring(okuCopy.indexOf("::") + 2);
                                }
                                okus.push(okuCopy);
                                let termCopy = dataArray[j][6];
                                while (termCopy.indexOf("::") > -1)
                                {
                                    let nthterm = termCopy.substring(0, termCopy.indexOf("::"));
                                    rdgs.push(nthterm);
                                    termCopy = termCopy.substring(termCopy.indexOf("::") + 2);
                                }
                                rdgs.push(termCopy);
                                for (let i = 0; i < rdgs.length; i++)
                                    if (i >= okus.length || okus[i] == "")
                                        output += rdgs[i] + ", ";
                                if (output.charAt(output.length - 2) == ",") output = output.substring(0, output.length-2);
                                output += "<br>";
                            }
                            output += "Vietnamese: ";
                            if (dataArray[j][5] == "") output += "No reading found";
                            else output += dataArray[j][5].replaceAll("::", ", ");
                        }
                        else if (viet && dataArray[j][5] == "" || kor && dataArray[j][6] == "" || jap && dataArray[j][7] == "" || chi && dataArray[j][8] == "")
                        {
                            output += "No reading found";
                            if (viet && dataArray[j][10] == "" || kor && dataArray[j][11] == "" || jap && dataArray[j][12] == "" || chi && dataArray[j][13] == "")
                            {
                                if (dataArray[j][9] == "")
                                    output += "<p><i>No definitions found</i></p>";
                                else
                                    output += "<p>" + dataArray[j][9] + "</p>";
                            }
                        }
                        else
                        {
                            let readIndex = 0;
                            if (viet) readIndex = 5;
                            if (kor)  readIndex = 6;
                            if (jap)  readIndex = 7;
                            if (chi)  readIndex = 8;
                            let termCopy = dataArray[j][readIndex];
                            while (termCopy.indexOf("::") > -1)
                            {
                                if (termCopy.substring(0, termCopy.indexOf("::")) == "")
                                    rdgs.push("<p>No reading found</p>");
                                else
                                {
                                    let nthterm = "<p>" + termCopy.substring(0, termCopy.indexOf("::")) + "（" + xinterm;
                                    rdgs.push(nthterm);
                                }
                                termCopy = termCopy.substring(termCopy.indexOf("::") + 2);
                            }
                            rdgs.push("<p>" + termCopy + "（" + xinterm);
                            
                            if (viet && dataArray[j][10] != "" || kor && dataArray[j][11] != "" || jap && dataArray[j][12] != "" || chi && dataArray[j][13] != "")
                            {
                                if (viet) readIndex = 10;
                                if (kor)  readIndex = 11;
                                if (jap)  readIndex = 12;
                                if (chi)  readIndex = 13;
                                let defCopy = dataArray[j][readIndex];
                                while (defCopy.indexOf("::") > -1)
                                {
                                    let nthterm = "<p>" + defCopy.substring(0, defCopy.indexOf("::")) + "</p>";
                                    defs.push(nthterm);
                                    defCopy = defCopy.substring(defCopy.indexOf("::") + 2);
                                }
                                defs.push("<p>" + defCopy + "</p>");
                            }
                            else
                            {
                                for (let r = defs.length; r < rdgs.length - 1; r++)
                                    defs.push("");
                                if (dataArray[j][9] == "")
                                    defs.push("<p><i>No definitions found</i></p>");
                                else
                                    defs.push("<p>" + dataArray[j][9] + "</p>");
                            }
                            
                            if (jap) readIndex = 14;
                            if (kor) readIndex = 15;
                            if (jap || kor)
                            {
                                let okuCopy = dataArray[j][readIndex];
                                while (okuCopy.indexOf("::") > -1)
                                {
                                    let nthterm = okuCopy.substring(0, okuCopy.indexOf("::"));
                                    okus.push(nthterm);
                                    okuCopy = okuCopy.substring(okuCopy.indexOf("::") + 2);
                                }
                                okus.push(okuCopy);
                            }
                            
                            if (defs.length > rdgs.length)
                            {
                                for (let d = rdgs.length; r < defs.length; r++)
                                {
                                    rdgs.push("<p>No reading found</p>");
                                }
                            }
                            if (rdgs.length > defs.length)
                            {
                                for (let r = defs.length; r < rdgs.length; r++)
                                {
                                    defs.push("<p><i>No definitions found</i></p>");
                                }
                            }
                            for (let m = 0; m < rdgs.length; m++)
                            {
                                if (m < okus.length)
                                    rdgs[m] += okus[m] + "）</p>";
                                else
                                    rdgs[m] += "）</p>";
                            }
                            for (let n = 0; n < rdgs.length; n++)
                            {
                                console.log(rdgs[n].substring(3, rdgs[n].length - 4));
                                if (!foundAltReading || foundAltReading && rdgs[n].substring(3, rdgs[n].length - 4) == checkString)
                                {
                                    output += rdgs[n];
                                    output += defs[n];
                                }
                            }
                        }
                        
                        if (tl)
                        {
                            if (dataArray[j][9] == "")
                                output += "<p><i>No definitions found</i></p>";
                            else
                            {
                                output += "<p>";
                                output += dataArray[j][9];
                                output += "</p>";
                            }
                        }
                        
                        if (!(k == 5 || k == 6 || k == 7 || k == 8))
                        {
                            break OUTER_LOOP;
                        }
                    }
                    else if (j == dataArray.length - 1 && k == dataArray[j].length - 1 && !foundMatch)
                    {
                        output2 = "No matches found";
                    }
                }
            }
            paragraph.innerHTML = output;
            paragraph2.innerHTML = output2;
        }
    </script>
    
    <h3><a href="https://fareast-english.fandom.com/wiki/Xinjianti">Learn more about Xinjianti</a></h3>
</body>

</html>
