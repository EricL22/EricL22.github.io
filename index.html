<!DOCTYPE html>
<html>

<head>
    <link rel="stylesheet" href="assets/css/newstyle.css">
</head>

<body>
    <h1>Hanzi Converters</h1>
    <p>Input Simplified characters into these converters; the Multilingual Dictionary also supports Xinjianti. Note that outside of fixed compounds, Simplified characters have a "default" traditional form on which they fall back when they have multiple definitions, so it is recommended to proofread these characters after conversion if they are used in isolation. <a href="https://fareast-english.fandom.com/wiki/List_of_New_Simplified_Forms_of_Chinese_Characters">Here is a list of traditional characters which the converter recognizes.</a></p>
    <h2>Xinjianti Converter</h2>

    <form>
      <input type="text" id="fname" name="fname"><br><br>
      <input type="button" value="Convert" onclick="msg()">
      <input type="button" value="Compatibility Mode" onclick="compat()">
    </form>
    
    <h5 id="compmode"><i></i></h5>
    <p id="demo">Enter a value above and click the button to convert it</p>

    <script>
        var compats = false;
        var csv = "";
        var dataArray;
        var request = new XMLHttpRequest();
        request.open('GET', 'https://EricL22.github.io/assets/data/xn-dict.csv', true);
        request.responseType = 'blob';
        request.onload = function() {
            var reader = new FileReader();
            reader.readAsText(request.response);
            reader.onload =  function(e){
                //console.log('Text:', e.target.result);
                csv = e.target.result;
        
                //var csv = '"foo, the column",bar\n2,3\n"4, the value",5',

                    // Split the input into lines
                    lines = csv.split('\n'),

                    // Extract column names from the first line
                    columnNamesLine = lines[0],
                    columnNames = parse(columnNamesLine),

                    // Extract data from subsequent lines
                    dataLines = lines.slice(1),
                    data = dataLines.map(parse);

                // Prints [["2","3"],["4, the value","5"]]
                dataArray = data;
                //console.log(JSON.stringify(dataArray));
            };
        };
        request.send();
        
        // Parse a CSV row, accounting for commas inside quotes                   
        function parse(row){
          var insideQuote = false,                                             
              entries = [],                                                    
              entry = [];
          row.split('').forEach(function (character) {                         
            if(character === '"') {
              insideQuote = !insideQuote;                                      
            } else {
              if(character == "," && !insideQuote) {                           
                entries.push(entry.join(''));                                  
                entry = [];                                                    
              } else {
                entry.push(character);                                         
              }                                                                
            }                                                                  
          });
          entries.push(entry.join(''));                                        
          return entries;                                                      
        }
        function compat() {
            var x = document.getElementById("compmode");
            if (x.textContent === "") {
                x.textContent = new String("Compatibility Mode Enabled");
                x.style.fontStyle = "italic";
            } else {
                x.textContent = "";
            }
            compats = !compats;
        }
        function msg() {
            const MAX_STRING_SIZE = 15;
            const button = document.querySelector('input');
            const paragraph = document.getElementById("demo");
            var checkString = document.getElementById("fname").value;
            var output = "";
            paragraph.textContent = "Working...";
            setTimeout(function() {
                while (checkString.length > 0)
                {
                    OUTER_LOOP: for (let i = checkString.length; i > 0; i--)
                    {
                        if (checkString.substring(0, i).length > MAX_STRING_SIZE)   continue;
                        for (let j = 0; j < dataArray.length; j++)
                        {
                            for (let k = 0; k < dataArray[j].length; k++)
                            {
                                if (checkString.substring(0, i) == dataArray[j][k] && isNaN(checkString.substring(0, i)))
                                {
                                    if (dataArray[j][3] == "1" || compats && dataArray[j][4] == "1")
                                        output += dataArray[j][2];
                                    else if (dataArray[j][3] == "" || dataArray[j][3].match(/^[0-9]+$/) != null || compats && dataArray[j][4] == "0")
                                        output += dataArray[j][1];
                                    else
                                        output += dataArray[j][3];
                                    checkString = checkString.substring(i);
                                    break OUTER_LOOP;
                                }
                                else if (j == dataArray.length - 1 && k == dataArray[j].length - 1 && i == 1)
                                {
                                    output += checkString.substring(0, i);
                                    checkString = checkString.substring(i);
                                    break OUTER_LOOP;
                                }
                            }
                        }
                    }
                }
                paragraph.textContent = output;
            }, 1);
        }
        function define() {
            const paragraph = document.getElementById("termout");
            paragraph.textContent = "No reading found";
            //paragraph.textContent = new String("No definitions found");
            //paragraph.style.fontStyle = "italic";
        }
    </script>

    <h2>Multilingual Dictionary</h2>
    <!-- <p>Test font 何故鞦甚榮？</p> -->

    <form>
      <input type="text" id="termin" name="termin"><br><br>
      <input type="button" value="Lookup" onclick="define()">
      <input type="button" value="Vietnamese" onclick="define()">
      <input type="button" value="Korean" onclick="define()">
      <input type="button" value="Japanese" onclick="define()">
      <input type="button" value="Chinese" onclick="define()">
    </form>
    
    <p id="termout">Enter a single term to be defined</p>
    
    <h3><a href="https://fareast-english.fandom.com/wiki/Xinjianti">Learn more about Xinjianti</a></h3>
</body>

</html>
